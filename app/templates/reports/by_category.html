{% extends "base.html" %}

{% block title %}Spending by Category - Subscription Manager{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('reports.index') }}">Reports</a></li>
                <li class="breadcrumb-item active">By Category</li>
            </ol>
        </nav>
        <h1 class="h3">
            <i class="bi bi-tags me-2"></i>Spending by Category
        </h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h5>Monthly: {{ currency }} {{ "%.2f"|format(total_monthly) }}</h5>
                <p class="text-muted mb-0">Yearly: {{ currency }} {{ "%.2f"|format(total_yearly) }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                {% if report_data %}
                <canvas id="categoryChart" height="150"></canvas>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if report_data %}
{% for data in report_data %}
<div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center" style="{% if data.category %}border-left: 4px solid {{ data.category.color }};{% endif %}">
        <div>
            {% if data.category %}
            <i class="bi {{ data.category.icon }} me-2"></i>
            <strong>{{ data.category.name }}</strong>
            {% else %}
            <i class="bi bi-question-circle me-2"></i>
            <strong>Uncategorized</strong>
            {% endif %}
            <span class="badge bg-secondary ms-2">{{ data.count }} subscription{{ 's' if data.count != 1 else '' }}</span>
        </div>
        <div class="text-end">
            <strong>{{ currency }} {{ "%.2f"|format(data.monthly_total) }}</strong>
            <small class="text-muted">/month</small>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-sm mb-0">
                <thead>
                    <tr>
                        <th>Subscription</th>
                        <th>Amount</th>
                        <th>Cycle</th>
                        <th>Monthly</th>
                    </tr>
                </thead>
                <tbody>
                    {% for sub in data.subscriptions %}
                    <tr>
                        <td><a href="{{ url_for('subscriptions.view', id=sub.id) }}">{{ sub.name }}</a></td>
                        <td>{{ sub.currency }} {{ "%.2f"|format(sub.amount) }}</td>
                        <td>{{ sub.billing_cycle|capitalize }}</td>
                        <td>{{ currency }} {{ "%.2f"|format(sub.get_monthly_amount(currency)) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endfor %}
{% else %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-pie-chart text-muted" style="font-size: 4rem;"></i>
        <h4 class="mt-3">No data to display</h4>
        <p class="text-muted">Add some subscriptions to see your spending by category.</p>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
{% if report_data %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('categoryChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: {{ report_data|map(attribute='category')|map(attribute='name', default='Uncategorized')|list|tojson }},
            datasets: [{
                data: {{ report_data|map(attribute='monthly_total')|list|tojson }},
                backgroundColor: [
                    {% for data in report_data %}
                    '{{ data.category.color if data.category else "#6c757d" }}'{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'right'
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}
